{% extends 'tracking/base.html' %}

{% block content %}

<style>
    @keyframes drawPath {
        to {
            stroke-dashoffset: 0;
        }
    }

    .flight-path {
        stroke-dasharray: 1000;
        stroke-dashoffset: 1000;
        animation: drawPath 15s linear infinite;
    }

    #airplane {
        transition: transform 0.1s linear;
    }
</style>


<div class="container mx-auto px-4 py-8 animate-fade-in">
    <!-- Tracking Header -->
    <div class="max-w-4xl mx-auto bg-gradient-to-r from-indigo-900 to-indigo-700 rounded-xl shadow-lg p-8 mb-8 transform hover:scale-[1.02] transition-all duration-300">
        <div class="text-white">
            <div class="flex items-center justify-between">
                <h2 class="text-3xl font-bold">Shipment Tracking</h2>
                <div class="animate-pulse">
                    <span class="inline-flex items-center px-4 py-2 rounded-full bg-white bg-opacity-20">
                        <span class="w-2 h-2 rounded-full bg-green-400 mr-2"></span>
                        Live Tracking
                    </span>
                </div>
            </div>
            <div class="mt-6 grid md:grid-cols-2 gap-6">
                <div class="bg-white bg-opacity-10 rounded-lg p-4">
                    <p class="text-indigo-200">Tracking Number</p>
                    <p class="text-2xl font-mono mt-1">{{ product.tracking_number }}</p>
                </div>
                <div class="bg-white bg-opacity-10 rounded-lg p-4">
                    <p class="text-indigo-200">Current Status</p>
                    <span class="inline-flex items-center px-4 py-2 rounded-full mt-1
                        {% if product.current_status == 'delivered' %}bg-green-500
                        {% elif product.current_status == 'in_transit' %}bg-blue-500
                        {% elif product.current_status == 'out_for_delivery' %}bg-yellow-500
                        {% else %}bg-gray-500{% endif %}">
                        <i class="fas {% if product.current_status == 'delivered' %}fa-check-circle
                            {% elif product.current_status == 'in_transit' %}fa-truck
                            {% elif product.current_status == 'out_for_delivery' %}fa-shipping-fast
                            {% else %}fa-box{% endif %} mr-2"></i>
                        {{ product.get_current_status_display }}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Shipment Progress -->
    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-8 mb-8">
        <div class="flex justify-between mb-8">
            <h3 class="text-xl font-semibold text-indigo-900">Shipment Progress</h3>
            <a href="{% url 'tracking:download_pdf' product.tracking_number %}" 
               class="inline-flex items-center px-4 py-2 bg-indigo-900 text-white rounded-lg hover:bg-indigo-800 transition-all duration-300 transform hover:scale-105">
                <i class="fas fa-download mr-2"></i>Download Report
            </a>
        </div>

        <!-- Shipping Details Cards -->
        <div class="grid md:grid-cols-2 gap-6 mb-8">
            <div class="bg-gray-50 rounded-xl p-6 transform hover:scale-105 transition-all duration-300">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-indigo-600"></i>
                    </div>
                    <h4 class="ml-4 font-semibold text-gray-900">Sender Details</h4>
                </div>
                <p class="text-gray-900 font-medium">{{ product.sender_name }}</p>
                <p class="text-gray-600 mt-1">{{ product.sender_address }}</p>
            </div>

            <div class="bg-gray-50 rounded-xl p-6 transform hover:scale-105 transition-all duration-300">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-map-marker-alt text-green-600"></i>
                    </div>
                    <h4 class="ml-4 font-semibold text-gray-900">Recipient Details</h4>
                </div>
                <p class="text-gray-900 font-medium">{{ product.recipient_name }}</p>
                <p class="text-gray-600 mt-1">{{ product.recipient_address }}</p>
            </div>
        </div>

        <!-- Timeline -->
        <div class="relative">
            {% for status in product.status_updates.all %}
            <div class="flex items-start mb-8 animate-slide-in" style="animation-delay: {{ forloop.counter0 }}00ms">
                <div class="flex-shrink-0">
                    <div class="w-12 h-12 rounded-full bg-indigo-100 flex items-center justify-center">
                        <i class="fas {% if status.status == 'delivered' %}fa-check-circle text-green-500
                            {% elif status.status == 'in_transit' %}fa-truck text-blue-500
                            {% elif status.status == 'out_for_delivery' %}fa-shipping-fast text-yellow-500
                            {% else %}fa-box text-gray-500{% endif %}"></i>
                    </div>
                </div>
                <div class="ml-6 flex-grow">
                    <div class="bg-white border border-gray-100 rounded-xl p-6 shadow-sm hover:shadow-md transition-all duration-300">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-semibold text-gray-900">{{ status.get_status_display }}</h4>
                                <p class="text-gray-600 mt-1">{{ status.location }}</p>
                            </div>
                            <span class="text-sm text-gray-500">{{ status.timestamp|date:"F j, Y H:i" }}</span>
                        </div>
                        <p class="mt-4 text-gray-700">{{ status.description }}</p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>




    <div class="container mx-auto">
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="relative h-48">
                <!-- SVG Container -->
                <svg class="w-full h-full" viewBox="0 0 800 160">
                    <!-- Dotted Background Path -->
                    <path 
                        d="M50,80 Q400,10 750,80" 
                        stroke="#E5E7EB" 
                        stroke-width="2" 
                        stroke-dasharray="5,5" 
                        fill="none" 
                    />
                    <!-- Animated Path -->
                    <path 
                        id="flightPath"
                        class="flight-path" 
                        d="M50,80 Q400,10 750,80" 
                        stroke="#4F46E5" 
                        stroke-width="2" 
                        fill="none" 
                    />
                    <!-- Origin Point -->
                    <circle cx="50" cy="80" r="6" fill="#4F46E5" />
                    <!-- Destination Point -->
                    <circle cx="750" cy="80" r="6" fill="#4F46E5" />
                </svg>

                <!-- Plane Icon -->
                <div id="airplane" class="absolute top-0 left-0 text-2xl text-indigo-600 transform -translate-y-1/2 -translate-x-1/2">
                    <i class="fas fa-plane"></i>
                </div>

                <!-- Location Labels -->
                <div class="absolute bottom-0 left-12 text-sm font-medium text-gray-600">
                    Origin
                </div>
                <div class="absolute bottom-0 right-12 text-sm font-medium text-gray-600">
                    Destination
                </div>
            </div>

            <!-- Shipment Info -->
            <div class="mt-4 grid grid-cols-2 gap-4">
                <div class="text-center">
                    <div class="text-sm text-gray-500">From</div>
                    <div class="font-medium text-indigo-900">Shipping Center</div>
                </div>
                <div class="text-center">
                    <div class="text-sm text-gray-500">To</div>
                    <div class="font-medium text-indigo-900">Destination</div>
                </div>
            </div>
        </div>
    </div>



    <!-- Map Section -->
    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-8 mb-8">
        <h3 class="text-xl font-semibold text-indigo-900 mb-6">Shipment Route</h3>
        <div id="map" class="h-96 rounded-xl shadow-inner"></div>
    </div>
</div>

<style>
@keyframes fade-in {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes slide-in {
    from { opacity: 0; transform: translateX(-20px); }
    to { opacity: 1; transform: translateX(0); }
}

.animate-fade-in {
    animation: fade-in 0.6s ease-out forwards;
}

.animate-slide-in {
    opacity: 0;
    animation: slide-in 0.5s ease-out forwards;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var map = L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    var markers = [];
    var coordinates = [
        {% for status in product.status_updates.all %}
            {% if status.latitude and status.longitude %}
                [{{ status.latitude }}, {{ status.longitude }}],
            {% endif %}
        {% endfor %}
    ];

    if (coordinates.length > 0) {
        coordinates.forEach(function(coord, index) {
            var marker = L.marker(coord, {
                icon: L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div class='marker-pin'></div>`,
                    iconSize: [30, 42],
                    iconAnchor: [15, 42]
                })
            }).addTo(map);
            markers.push(marker);
        });

        var path = L.polyline(coordinates, {
            color: '#4F46E5',
            weight: 4,
            opacity: 0.8,
            dashArray: '10, 10',
            animate: true
        }).addTo(map);

        var bounds = L.latLngBounds(coordinates);
        map.fitBounds(bounds, {padding: [50, 50]});
    }
});
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const airplane = document.getElementById('airplane');
        const flightPath = document.getElementById('flightPath');
        
        function animateAirplane() {
            const pathLength = flightPath.getTotalLength();
            const duration = 200000; // 15 seconds
            
            function update(timestamp) {
                const elapsed = (timestamp % duration) / duration;
                const point = flightPath.getPointAtLength(elapsed * pathLength);
                
                // Calculate rotation based on the path
                const nextPoint = flightPath.getPointAtLength((elapsed + 0.01) * pathLength);
                const angle = Math.atan2(nextPoint.y - point.y, nextPoint.x - point.x) * 180 / Math.PI;
                
                airplane.style.transform = `translate(${point.x}px, ${point.y}px) rotate(${angle + 25}deg)`;
                requestAnimationFrame(update);
            }
            
            requestAnimationFrame(update);
        }
        
        animateAirplane();
    });
    </script>



<style>
.marker-pin {
    width: 30px;
    height: 30px;
    border-radius: 50% 50% 50% 0;
    background: #4F46E5;
    position: absolute;
    transform: rotate(-45deg);
    left: 50%;
    top: 50%;
    margin: -15px 0 0 -15px;
    animation: bounce 0.5s ease-out;
}

@keyframes bounce {
    0% { transform: rotate(-45deg) translateY(-20px); opacity: 0; }
    100% { transform: rotate(-45deg) translateY(0); opacity: 1; }
}
</style>
{% endblock %}
